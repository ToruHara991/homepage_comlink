<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>台灣自來水公司第一區管理處業務課-電子會議目錄</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Microsoft JhengHei', '微軟正黑體', Arial, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
      padding: 20px;
      line-height: 1.6;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .header {
      background: #2c5aa0;
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 1.8rem;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .controls {
      padding: 25px 30px;
      background: #f8f9fa;
      display: flex;
      gap: 20px;
      align-items: center;
      flex-wrap: wrap;
      border-bottom: 1px solid #e9ecef;
    }

    .year-selector {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .year-selector label {
      font-weight: 500;
      color: #495057;
    }

    .year-selector select {
      padding: 8px 12px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 14px;
      background: white;
      cursor: pointer;
    }

    .search-box {
      flex: 1;
      position: relative;
      min-width: 250px;
    }

    .search-box input {
      width: 100%;
      padding: 8px 35px 8px 12px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 14px;
    }

    .search-box input:focus {
      outline: none;
      border-color: #2c5aa0;
    }

    .search-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #6c757d;
      font-size: 14px;
    }

    .refresh-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .refresh-btn:hover {
      background: #218838;
    }

    .refresh-btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }

    .main-content {
      padding: 30px;
    }

    .month-item {
      margin-bottom: 15px;
      border: 1px solid #e9ecef;
      border-radius: 6px;
      background: white;
    }

    .month-header {
      padding: 15px 20px;
      background: #f8f9fa;
      border-bottom: 1px solid #e9ecef;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background-color 0.2s;
    }

    .month-header:hover {
      background: #e9ecef;
    }

    .month-title {
      font-size: 1.1rem;
      font-weight: 500;
      color: #495057;
    }

    .meeting-count {
      font-size: 0.9rem;
      color: #6c757d;
    }

    .expand-icon {
      font-size: 14px;
      color: #6c757d;
      transition: transform 0.2s;
    }

    .month-item.expanded .expand-icon {
      transform: rotate(180deg);
    }

    .month-content {
      display: none;
      padding: 20px;
    }

    .month-item.expanded .month-content {
      display: block;
    }

    .meeting-type {
      margin-bottom: 25px;
    }

    .meeting-type:last-child {
      margin-bottom: 0;
    }

    .type-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e9ecef;
    }

    .type-badge {
      padding: 4px 8px;
      border-radius: 3px;
      font-size: 12px;
      font-weight: 500;
      color: white;
    }

    .type-badge.business {
      background: #28a745;
    }

    .type-badge.emergency {
      background: #dc3545;
    }

    .type-header h4 {
      color: #495057;
      font-size: 1rem;
      font-weight: 500;
    }

    .meeting-item {
      background: #f8f9fa;
      margin-bottom: 8px;
      border-radius: 4px;
      border: 1px solid #e9ecef;
      transition: all 0.2s;
    }

    .meeting-item:hover {
      background: #e9ecef;
      border-color: #ced4da;
    }

    .meeting-link {
      display: block;
      padding: 12px 15px;
      text-decoration: none;
      color: #495057;
    }

    .meeting-title {
      font-weight: 600;
      margin-bottom: 4px;
      color: #2c5aa0;
      font-size: 1.1rem;
    }

    .meeting-date {
      font-size: 0.9rem;
      color: #6c757d;
    }

    .status-message {
      text-align: center;
      padding: 30px 20px;
      border-radius: 4px;
      margin-bottom: 20px;
    }

    .loading {
      color: #6c757d;
      background: #f8f9fa;
      border: 1px solid #dee2e6;
    }

    .error {
      color: #721c24;
      background: #f8d7da;
      border: 1px solid #f5c6cb;
    }

    .success {
      color: #155724;
      background: #d4edda;
      border: 1px solid #c3e6cb;
    }

    .no-meetings {
      text-align: center;
      color: #6c757d;
      font-style: italic;
      padding: 30px 20px;
    }

    .setup-info {
      background: #e3f2fd;
      border: 1px solid #bbdefb;
      color: #1565c0;
      padding: 20px;
      border-radius: 4px;
      margin-bottom: 20px;
    }

    .setup-info h4 {
      margin-bottom: 10px;
    }

    .setup-info a {
      color: #1565c0;
      text-decoration: underline;
    }

    @media (max-width: 768px) {
      .header h1 {
        font-size: 1.5rem;
      }

      .controls {
        flex-direction: column;
        align-items: stretch;
      }

      .search-box {
        min-width: unset;
      }

      .main-content {
        padding: 20px;
      }
    }

    .footer {
      background: #2c5aa0;
      color: white;
      margin-top: 50px;
      padding: 25px 0;
      text-align: center;
    }

    .footer-content {
      max-width: 1000px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .footer p {
      margin: 5px 0;
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .footer p:first-child {
      font-weight: 500;
      margin-bottom: 8px;
    }

    .video-section {
      background: #f8f9fa;
      padding: 40px 20px;
      margin-top: 30px;
    }

    .video-container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .video-title {
      color: #2c5aa0;
      font-size: 1.3rem;
      margin-bottom: 20px;
      text-align: center;
      font-weight: 500;
    }

    .video-wrapper {
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .video-wrapper video,
    .video-wrapper iframe {
      width: 100%;
      height: 400px;
      border: none;
    }

    @media (max-width: 768px) {

      .video-wrapper video,
      .video-wrapper iframe {
        height: 250px;
      }
    }
    /* 基本連結樣式 */
    a.change-color-link {
      color: #007bff;
      text-decoration: none;
      transition: color 0.3s ease;
    }

    /* 滑鼠移上去時變色 */
    a.change-color-link:hover {
      color: #d9534f;
    }

    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>台灣自來水公司第一區管理處業務課</h1>
      <p>電子會議目錄</p>
    </div>
    <div class="controls">
      <div class="year-selector">
        <label for="yearSelect">年度:</label>
        <select id="yearSelect">
          <option selected value="2025">2025年</option>
        </select>
      </div>
      <div class="search-box">
        <input id="searchInput" placeholder="搜尋會議..." type="text">
        <span class="search-icon">🔍</span>
      </div>
      <button id="refreshBtn" class="refresh-btn">
        <span>🔄</span> 重新載入
      </button>
    </div>
    <div class="main-content">
      <div id="setupInfo" class="setup-info">
        <h4>🗓️ 公告/設定</h4>
        <ol style="margin: 10px 0 10px 20px;">
          <lia>📢&nbsp; 本資料使用replit託管(常駐休眠)，開會時請通知人員喚醒</lia>
          <br>
          <lia>🔔&nbsp; 開會資料，請在Q槽能使用時開啟</lia>
        </ol>
      </div>

      <div id="monthsList">
        <div class="status-message loading">載入會議資料中...</div>
      </div>
		 <a class="change-color-link" href="https://docs.google.com/spreadsheets/d/1PlRQNzd8YxVTQXWREMysjtsFPOUpUftjw4zuz1efG9Q/edit?usp=sharing" target="_blank">
		🔧&nbsp; Update/Add Date By Google sheets (Staff Only)
		 </a>
    </div>
  </div>
  <div class="video-section">
    <div class="video-container">
      <h3 class="video-title">枯水期間，請大家節約用水珍惜水資源</h3>
      <div class="video-wrapper">
	<iframe width="100%" height="400" 
  	src="https://www.youtube.com/embed/MTgyRtQ_zTQ" 
  	frameborder="0" 
  	allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
  	allowfullscreen>
	</iframe>
      </div>
    </div>
  </div>

  <script>
    const monthNames = ['', '一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'];
    let meetingsData = {};
    async function loadGoogleSheetsData() {
      showMessage('loading', '正在載入資料...');
      try {
        const url = 'https://5721728b-9885-4a8c-9e25-6639f9e3afa7-00-32kctlyfxokt0.picard.replit.dev/api/sheets/data';
        const response = await fetch(url);
        const result = await response.json();
        if (!result.values || result.values.length === 0) {
          throw new Error('試算表沒有資料');
        }
        meetingsData = convertValuesToMeetings(result.values);
        generateYearOptions();
        renderMeetings(getCurrentYear());
        // ✅ 這裡改掉，不再覆蓋 monthsList
        console.log(`成功載入 ${countTotalMeetings()} 筆資料`);
      } catch (err) {
        console.error(err);
        showMessage('error', `資料載入失敗：${err.message}`);
      }
    }
    // ✅ 改寫：用 values 陣列解析
    function convertValuesToMeetings(values) {
      const meetings = {};
      for (let i = 0; i < values.length; i++) {
        const row = values[i];
        if (row.length < 6) continue;
        const year = row[0]?.toString() || '';
        const month = parseInt(row[1]) || 0;
        const type = row[2]?.toString().toLowerCase() || '';
        const title = row[3]?.toString() || '';
        const date = row[4]?.toString() || '';
        const link = row[5]?.toString() || '';
        if (!year || !month || !title) continue;
        if (!meetings[year]) meetings[year] = {};
        if (!meetings[year][month]) {
          meetings[year][month] = {
            business: [],
            emergency: []
          };
        }
        const meetingType = (type === 'emergency' || type === '臨時') ? 'emergency' : 'business';
        meetings[year][month][meetingType].push({
          title,
          date,
          link
        });
      }
      return meetings;
    }
    // 顯示狀態訊息
    // ✅ 修正 showMessage：只在載入或錯誤時顯示提示
    function showMessage(type, message) {
      const monthsList = document.getElementById('monthsList');
      if (type === 'loading' || type === 'error') {
        monthsList.innerHTML = `<div class="status-message ${type}">${message}</div>`;
      }
    }
    // 計算總會議數量
    function countTotalMeetings() {
      let total = 0;
      Object.values(meetingsData).forEach(yearData => {
        Object.values(yearData).forEach(monthData => {
          total += monthData.business.length + monthData.emergency.length;
        });
      });
      return total;
    }
    // 取得當前年份
    function getCurrentYear() {
      const years = Object.keys(meetingsData);
      return years.length > 0 ? years[0] : new Date().getFullYear().toString();
    }
    // 動態產生年度選項
    function generateYearOptions() {
      const yearSelect = document.getElementById('yearSelect');
      const currentSelectedYear = yearSelect.value;
      yearSelect.innerHTML = '';
      const years = Object.keys(meetingsData).sort((a, b) => parseInt(b) - parseInt(a));
      years.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = `${year}年`;
        if (year === currentSelectedYear) {
          option.selected = true;
        }
        yearSelect.appendChild(option);
      });
      if (years.length > 0 && !years.includes(currentSelectedYear)) {
        yearSelect.value = years[0];
      }
    }

    function renderMeetings(year, searchTerm = '') {
      const monthsList = document.getElementById('monthsList');
      const yearData = meetingsData[year] || {};
      const hasData = Object.keys(yearData).length > 0;
      if (!hasData) {
        monthsList.innerHTML = '<div class="no-meetings">本年度暫無會議記錄</div>';
        return;
      }
      const sortedMonths = Object.keys(yearData).sort((a, b) => parseInt(a) - parseInt(b));
      let hasMatchingResults = false;
      monthsList.innerHTML = '';
      sortedMonths.forEach(month => {
        const monthData = yearData[month];
        let filteredBusiness = monthData.business ? monthData.business.filter(meeting =>
          meeting.title.toLowerCase().includes(searchTerm.toLowerCase())
        ) : [];
        let filteredEmergency = monthData.emergency ? monthData.emergency.filter(meeting =>
          meeting.title.toLowerCase().includes(searchTerm.toLowerCase())
        ) : [];
        if (searchTerm && filteredBusiness.length === 0 && filteredEmergency.length === 0) {
          return;
        }
        hasMatchingResults = true;
        const totalMeetings = filteredBusiness.length + filteredEmergency.length;
        const monthInt = parseInt(month);
        const currentDate = new Date();
        const currentYear = currentDate.getFullYear();
        const currentMonth = currentDate.getMonth() + 1;
        const monthItem = document.createElement('div');
        monthItem.className = `month-item ${monthInt === currentMonth && year == currentYear && !searchTerm ? 'expanded' : ''}`;
        monthItem.innerHTML = `
	                   <div class="month-header" onclick="toggleMonth(this)">
	                       <div class="month-info">
	                           <span class="month-title">${monthNames[monthInt]}</span>
	                           <span class="meeting-count">共 ${totalMeetings} 場會議</span>
	                       </div>
	                       <span class="expand-icon">▼</span>
	                   </div>
	                   <div class="month-content">
	                       ${filteredBusiness.length > 0 ? `
	                           <div class="meeting-type">
	                               <div class="type-header">
	                                   <span class="type-badge business">業務</span>
	                                   <h4>責任中心會議</h4>
	                               </div>
	                               ${filteredBusiness.map(meeting => `
	                                   <div class="meeting-item">
	                                       <a href="${meeting.link}" class="meeting-link" target="_blank" rel="noopener noreferrer">
	                                           <div class="meeting-title">${meeting.title}</div>
	                                           <div class="meeting-date">${meeting.date}</div>
	                                       </a>
	                                   </div>
	                               `).join('')}
	                           </div>
	                       ` : ''}
	                       ${filteredEmergency.length > 0 ? `
	                           <div class="meeting-type">
	                               <div class="type-header">
	                                   <span class="type-badge emergency">臨時</span>
	                                   <h4>臨時會議</h4>
	                               </div>
	                               ${filteredEmergency.map(meeting => `
	                                   <div class="meeting-item">
	                                       <a href="${meeting.link}" class="meeting-link" target="_blank" rel="noopener noreferrer">
	                                           <div class="meeting-title">${meeting.title}</div>
	                                           <div class="meeting-date">${meeting.date}</div>
	                                       </a>
	                                   </div>
	                               `).join('')}
	                           </div>
	                       ` : ''}
	                       ${filteredBusiness.length === 0 && filteredEmergency.length === 0 ? `
	                           <div class="no-meetings">本月暫無會議記錄</div>
	                       ` : ''}
	                   </div>
	               `;
        monthsList.appendChild(monthItem);
      });
      if (!hasMatchingResults && searchTerm) {
        monthsList.innerHTML = '<div class="no-meetings">找不到符合搜尋條件的會議</div>';
      }
    }

    function toggleMonth(header) {
      const monthItem = header.parentElement;
      monthItem.classList.toggle('expanded');
    }
    // 事件監聽器
    document.getElementById('yearSelect').addEventListener('change', (e) => {
      const year = e.target.value;
      const searchTerm = document.getElementById('searchInput').value;
      renderMeetings(year, searchTerm);
    });
    document.getElementById('searchInput').addEventListener('input', (e) => {
      const searchTerm = e.target.value;
      const year = document.getElementById('yearSelect').value;
      renderMeetings(year, searchTerm);
    });
    document.getElementById('refreshBtn').addEventListener('click', () => {
      loadGoogleSheetsData();
    });
    // 初始化載入
    document.addEventListener('DOMContentLoaded', () => {
      loadGoogleSheetsData();
    });
  </script>
  <footer class="footer">
    <div class="footer-content">
      <p>© 2025 ALL RIGHTS RESERVED.</p>
      <p>This page was created by 阿谷. (Made by 阿谷. Not maintained.)</p>
    </div>
  </footer>
</body>

</html>